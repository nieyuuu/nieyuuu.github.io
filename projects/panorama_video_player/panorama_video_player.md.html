<meta charset="utf-8" emacsmode="-*- markdown -*-"><link rel="stylesheet" href="https://casual-effects.com/markdeep/latest/journal.css?">

**全景视频播放**

# 项目简介

本项目将给定的预渲染的高质量全景视频作为输入，当播放视频时，用户可以自由调整自身俯仰角和偏航角。最终视频将被部署在5760×1080分辨率的LED屏幕以及1920×1080×14的投影曲面屏上，如下图所示。项目较为庞大，设计视频的解复用、解码、显示、任务调度、音频字幕加载播放、效率优化等，在其中我主要负责了项目的部分测试工作以及Tile查找算法的实现。项目以C++编写，主要依赖FFMpeg、Cuda、TBB等三方库，单元测试采用微软的单元测试框架。

![曲面屏图示](figures/led.png)

# 项目总结

## 单例模式下的单元测试

在实际进行测试时，单例模式在单元测试下造成了不小的麻烦。项目在设计之初将视频显示部分，以单例模式进行封装。但在一次性运行所有单元测试时，测试过程将会卡死在某个测试用例上。随即我们发现：在单元测试下，某些测试用例的显示部分是同一个实例，即这些测试用例共享了同一个对象。因此，当单独运行某个测试用例时，这个测试用例可以正常通过，一旦同时运行这些测试用例，就会出现测试过程卡死、测试用例不通过的现象。

## Tile查找

Tile，即将全景视频的每一个大视频都“切割”成4×4或5×5的小视频，每一个小视频即为一个Tile。Tile查找，即计算出当前用户可以看见的小Tile具体是哪些。之所以需要将视频进行切割并查找可见的小Tile，是因为用户主机解码效率跟不上。当原始全景视频的分辨率为2k×2k时，几乎不能达到24帧/s的要求了。因此，我们通过将视频“切割”，只播放当前可见的小视频即可。

# 成果

下面的视频展示了在5760×1080分辨率的LED屏幕上的效果，视频播放过程中，用户可以控制自身俯仰角及偏航角的变化，获得一种在天空飞翔的真实感受。

![5760×1080](led.mp4 width = "100%")

接下来的视频展示了14个1920×1080分辨率投影仪投影在曲面屏上的结果（上下两层分别布置7个投影仪。视频中只打开了下层的投影仪，因此视频开头可以观察到字幕被截断）。

![1920×1080×14](multi_projector.mp4 width = "100%")

<style class="fallback">body{visibility:hidden}</style>
<script>markdeepOptions={tocStyle:'none'};</script>
<script src="https://casual-effects.com/markdeep/latest/markdeep.min.js?" charset="utf-8"></script>